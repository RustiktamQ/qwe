<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FastTest — Прохождение квиза</title>
    <meta
      name="description"
      content="Страница прохождения квиза FastTest — один вопрос за раз, без авторизации."
    />
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='6' y='6' width='52' height='52' rx='12' fill='%231a73e8'/%3E%3Cpath d='M18 33h28M18 24h20M18 42h24' stroke='%23fff' stroke-width='6' stroke-linecap='round'/%3E%3C/svg%3E"
    />
    <style>
      :root {
        --bg: #ffffff;
        --surface: #ffffff;
        --ink: #0b1220;
        --muted: #5f6b7a;
        --blue: #1a73e8;
        --green: #16a34a;
        --line: #e6e8ee;
        --shadow: 0 8px 30px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.05);
        --radius-lg: 16px;
        --radius: 12px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font: 16px/1.55 Inter, ui-sans-serif, system-ui, -apple-system,
          'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        color: var(--ink);
        background: var(--bg);
      }
      a {
        color: var(--blue);
        text-decoration: none;
      }
      .header {
        position: sticky;
        top: 0;
        z-index: 50;
        background: var(--surface);
        border-bottom: 1px solid var(--line);
      }
      .header__inner {
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 800;
      }
      .logo {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--blue), #5aa1ff);
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 900;
      }
      .nav {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 40px;
        padding: 0 14px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #fff;
        cursor: pointer;
        font-weight: 700;
      }
      .btn:hover {
        box-shadow: var(--shadow);
      }
      .btn.primary {
        background: var(--blue);
        border-color: transparent;
        color: #fff;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      .progress {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0 16px;
      }
      .bar {
        flex: 1;
        height: 10px;
        border-radius: 999px;
        background: #eef2ff;
        border: 1px solid var(--line);
        overflow: hidden;
      }
      .bar > span {
        display: block;
        height: 100%;
        background: var(--blue);
        width: 0%;
      }
      .badge {
        background: #f2f7ff;
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
        color: #1357b7;
      }
      .card {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        padding: 16px;
        margin-bottom: 14px;
      }
      .qtext {
        font-size: 18px;
        font-weight: 800;
        margin: 0 0 10px;
      }
      .options {
        display: grid;
        gap: 10px;
      }
      .opt {
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px 12px;
        background: #fff;
        cursor: pointer;
      }
      .opt input {
        width: 18px;
        height: 18px;
      }
      .opt:hover {
        box-shadow: var(--shadow);
      }
      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        margin-top: 12px;
      }
      .result {
        display: grid;
        gap: 10px;
        place-items: center;
        text-align: center;
      }
      .score {
        font-size: 36px;
        font-weight: 900;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #111827;
        color: #fff;
        border-radius: 10px;
        padding: 10px 14px;
        font-size: 14px;
        box-shadow: var(--shadow);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 80;
      }
      .toast.show {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header__inner">
        <div class="brand">
          <div class="logo" aria-hidden="true">F</div>
          <div>FastTest</div>
        </div>
        <nav class="nav" aria-label="Навигация">
          <a class="btn" href="/">Главная</a>
          <a class="btn" id="api-link" href="#">API</a>
        </nav>
      </div>
    </header>

    <main class="container" role="main">
      <div class="progress" aria-label="Прогресс">
        <div class="badge" id="qid">Вопрос —/—</div>
        <div class="bar" aria-hidden="true"><span id="bar"></span></div>
      </div>

      <section class="card" id="card" hidden>
        <p class="qtext" id="qtext"></p>
        <form
          id="form"
          class="options"
          role="radiogroup"
          aria-labelledby="qtext"
        ></form>
        <div class="toolbar">
          <span class="muted">Выберите вариант и нажмите «Далее»</span>
          <div style="display: flex; gap: 8px">
            <button class="btn" id="prev" type="button">Назад</button>
            <button class="btn primary" id="next" type="button" disabled>
              Далее
            </button>
          </div>
        </div>
      </section>

      <section class="card" id="start">
        <h1 style="margin: 0 0 6px">Квиз</h1>
        <p class="muted" id="meta">
          Отвечайте последовательно — по одному вопросу. Авторизация не
          требуется.
        </p>
        <button class="btn primary" id="begin">Начать</button>
      </section>

      <section class="card result" id="finish" hidden>
        <div class="score" id="score">0 / 0</div>
        <div class="muted" id="remark">—</div>
        <div
          style="
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
          "
        >
          <button class="btn" id="retry">Пройти ещё раз</button>
        </div>
      </section>
    </main>

    <div class="toast" id="toast">Загрузка…</div>

    <script type="module">
      import ApiController from './scripts/apiController.js';
      import config from './config.js';

      const $ = (s) => document.querySelector(s);
      const toast = $('#toast');
      const showToast = (t) => {
        toast.textContent = t;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 1200);
      };

      const apiLink = document.getElementById('api-link');
      apiLink.href = `${config.FULL_HOST}/api/docs`;

      function parseQuizId() {
        const u = new URL(location.href);
        const idParam = u.searchParams.get('id');
        if (idParam) return Number(idParam);
        const weird = u.search.replace(/^\?=/, '');
        if (weird) return Number(weird);
        const seg = u.pathname.split('/').filter(Boolean);
        const last = seg[seg.length - 1];
        if (!isNaN(Number(last))) return Number(last);
        return 0;
      }

      function shuffle(arr) {
        const a = arr.slice();
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      async function loadQuizFromBackend(testId) {
        const api = new ApiController();
        const all = await api.getAllTests();
        if (!Array.isArray(all))
          throw new Error('Не удалось получить список тестов');
        const test = all.find((t) => Number(t.test_id) === Number(testId));
        if (!test) throw new Error('Тест не найден');
        const questions = Array.isArray(test.questions) ? test.questions : [];
        const withOpts = [];
        for (const q of questions) {
          const qid = q.question_id ?? q.id;
          const optsRow = await api.getOptionsByQuestion(qid);
          const opts = [
            { text: String(optsRow?.correct ?? ''), correct: true },
            { text: String(optsRow?.incorrect1 ?? ''), correct: false },
            { text: String(optsRow?.incorrect2 ?? ''), correct: false },
            { text: String(optsRow?.incorrect3 ?? ''), correct: false },
          ].filter((o) => o.text.trim() !== '');
          withOpts.push({ text: String(q.text || ''), options: shuffle(opts) });
        }
        return { name: String(test.name || 'Квиз'), items: withOpts };
      }

      let quiz = [];
      let idx = 0;
      let answers = [];

      const qid = document.getElementById('qid');
      const bar = document.getElementById('bar');
      const card = document.getElementById('card');
      const qtext = document.getElementById('qtext');
      const form = document.getElementById('form');
      const start = document.getElementById('start');
      const begin = document.getElementById('begin');
      const finish = document.getElementById('finish');
      const scoreEl = document.getElementById('score');
      const remark = document.getElementById('remark');
      const nextBtn = document.getElementById('next');
      const prevBtn = document.getElementById('prev');
      const retryBtn = document.getElementById('retry');
      const meta = document.getElementById('meta');

      function updateProgress() {
        qid.textContent = `Вопрос ${Math.min(idx + 1, quiz.length)} / ${
          quiz.length
        }`;
        bar.style.width = (quiz.length ? (idx / quiz.length) * 100 : 0) + '%';
      }

      function renderQuestion() {
        const q = quiz[idx];
        if (!q) return;
        updateProgress();
        qtext.textContent = q.text;
        form.innerHTML = '';
        q.options.forEach((o, i) => {
          const id = `opt-${idx}-${i}`;
          const label = document.createElement('label');
          label.className = 'opt';
          label.setAttribute('for', id);
          label.innerHTML = `<input type="radio" name="q${idx}" id="${id}" value="${i}"><span>${o.text}</span>`;
          form.appendChild(label);
        });
        const picked = answers[idx];
        if (picked !== undefined) {
          const input = form.querySelector(`input[value="${picked}"]`);
          if (input) {
            input.checked = true;
            nextBtn.disabled = false;
          }
        } else {
          nextBtn.disabled = true;
        }
      }

      function showCard() {
        start.hidden = true;
        finish.hidden = true;
        card.hidden = false;
        renderQuestion();
      }

      function showStart(title) {
        start.hidden = false;
        finish.hidden = true;
        card.hidden = true;
        qid.textContent = 'Вопрос —/—';
        bar.style.width = '0%';
        if (title)
          meta.textContent = `Квиз: ${title}. Вопросов: ${quiz.length}.`;
      }

      function showFinish() {
        start.hidden = true;
        card.hidden = true;
        finish.hidden = false;
        qid.textContent = 'Готово';
        bar.style.width = '100%';
        let correct = 0;
        quiz.forEach((q, i) => {
          if (q.options[answers[i]]?.correct) correct++;
        });
        scoreEl.textContent = `${correct} / ${quiz.length}`;
        const pct = Math.round((correct / quiz.length) * 100);
        remark.textContent =
          pct >= 80
            ? 'Отличный результат!'
            : pct >= 50
            ? 'Неплохо! Есть, куда расти.'
            : 'Нужно подтянуть тему.';
      }

      form.addEventListener('change', (e) => {
        const input = e.target;
        if (input && input.type === 'radio') {
          answers[idx] = Number(input.value);
          nextBtn.disabled = false;
        }
      });

      nextBtn.addEventListener('click', () => {
        if (answers[idx] === undefined) return;
        if (idx < quiz.length - 1) {
          idx++;
          renderQuestion();
        } else {
          showFinish();
        }
      });

      prevBtn.addEventListener('click', () => {
        if (idx > 0) {
          idx--;
          renderQuestion();
        }
      });

      begin.addEventListener('click', () => {
        idx = 0;
        answers = [];
        showCard();
      });
      retryBtn.addEventListener('click', () => {
        idx = 0;
        answers = [];
        showCard();
      });

      window.addEventListener('keydown', (e) => {
        if (card.hidden) return;
        if (['1', '2', '3', '4'].includes(e.key)) {
          const k = Number(e.key) - 1;
          const input = form.querySelectorAll('input[type=radio]')[k];
          if (input) {
            input.checked = true;
            input.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }
        if (e.key === 'Enter') {
          e.preventDefault();
          if (!nextBtn.disabled) nextBtn.click();
        }
      });

      const testId = parseQuizId();
      try {
        showToast('Загружаем квиз…');
        const data = await loadQuizFromBackend(testId);
        quiz = data.items;
        showStart(data.name);
      } catch (e) {
        showStart();
        toast.textContent = String(e.message || 'Ошибка загрузки');
        toast.classList.add('show');
      }
    </script>
  </body>
</html>
